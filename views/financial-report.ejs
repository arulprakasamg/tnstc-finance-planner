<% 
  // Local helpers for date conversion
  const toInputDate = (dmy) => {
    if (!dmy || !dmy.includes('/')) return dmy;
    const [d, m, y] = dmy.split('/');
    return `${y}-${m}-${d}`;
  };

  const toDisplayDate = (ymd) => {
    if (!ymd || !ymd.includes('-')) return ymd;
    const [y, m, d] = ymd.split('-');
    return `${d}/${m}/${y}`;
  };
%>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Report - TNSTC Finance Planner</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .report-header { text-align: center; margin-bottom: 2rem; }
        .report-header h2 { font-size: 1.5rem; color: #1a3c5e; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; }
        .date-selector-container { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); max-width: 400px; margin: 0 auto; display: flex; align-items: center; gap: 1rem; margin-bottom: 2.5rem; }
        .date-selector-container label { font-weight: 600; color: #1a3c5e; white-space: nowrap; }
        .date-selector-container input { padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; width: 100%; }
        
        .report-section { margin-top: 3rem; }
        .section-title { font-size: 1.1rem; font-weight: 800; color: #1a3c5e; border-bottom: 2px solid #1a3c5e; padding-bottom: 0.5rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: flex-end; }
        .section-title span { font-size: 0.85rem; font-weight: 600; color: #64748b; }
        
        .horizontal-table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .horizontal-table th, .horizontal-table td { padding: 1rem; border: 1px solid #e2e8f0; text-align: right; font-size: 0.95rem; }
        .horizontal-table th { background: #f8fafc; color: #1a3c5e; font-weight: 700; text-align: left; }
        .horizontal-table td:first-child { background: #f8fafc; color: #1a3c5e; font-weight: 700; text-align: left; width: 150px; }
        
        .grand-total { text-align: right; font-size: 1.2rem; font-weight: 800; color: #1a3c5e; margin-top: 1rem; }

        .split-section { display: grid; grid-template-columns: 1fr 1fr; border: 2px solid #1a3c5e; background: white; margin-top: 1.5rem; }
        .split-col { padding: 1.5rem; }
        .split-col:first-child { border-right: 2px solid #1a3c5e; }
        .split-header { font-weight: 800; text-align: center; border-bottom: 2px solid #1a3c5e; margin: -1.5rem -1.5rem 1.5rem -1.5rem; padding: 0.8rem; background: #f8fafc; color: #1a3c5e; }
        
        .data-row { display: flex; justify-content: space-between; margin-bottom: 0.8rem; font-size: 0.95rem; }
        .data-row .label { color: #1e293b; }
        .data-row .value { font-weight: 700; color: #1a3c5e; }
        .data-row.highlight { margin-top: 1.5rem; border-top: 1px solid #e2e8f0; padding-top: 1rem; }
        .data-row.highlight .value { font-size: 1.1rem; color: #1a3c5e; }
        .data-row.balance-row { border-top: 2px solid #1a3c5e; margin-top: 1rem; padding-top: 1rem; }
        .data-row.balance-row .value { font-size: 1.1rem; color: #1a3c5e; }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header"><h2>TNSTC Finance</h2></div>
        <ul class="sidebar-menu">
            <li><a href="/">Dashboard</a></li>
            <li><a href="/bank-balances">Bank Balances</a></li>
            <li><a href="/daily-collections">Daily Collections</a></li>
            <li><a href="/payment-planning">Payment Planning</a></li>
            <li><a href="/hsd-management">HSD Management</a></li>
            <li><a href="/financial-report" class="active">Financial Report</a></li>
        </ul>
    </nav>
    <div class="main-content">
        <header>
            <h1>Financial Report</h1>
            <p class="date-range">Finance Position Analysis</p>
        </header>
        <main class="container">
            <div class="report-header">
                <h2>TNSTC KUMBAKONAM – FINANCE POSITION</h2>
            </div>
            <div class="date-selector-container">
                <label for="positionDateInput">Position Date</label>
                <input type="date" id="positionDateInput" value="<%= toInputDate(positionDate) %>" onchange="handleDateChange(this.value)">
            </div>

            <script>
                function handleDateChange(ymd) {
                    if (!ymd) return;
                    const parts = ymd.split('-');
                    const dmy = `${parts[2]}/${parts[1]}/${parts[0]}`;
                    window.location.href = '/financial-report?positionDate=' + dmy;
                }
            </script>

            <!-- Bank Balances Section -->
            <section class="report-section">
                <div class="section-title">
                    BANK BALANCES
                    <span>(Rs. in Crores)</span>
                </div>
                <table class="horizontal-table">
                    <thead>
                        <tr>
                            <th>Bank</th>
                            <% bankData.forEach(bank => { %>
                                <th style="text-align: right;"><%= bank.name %></th>
                            <% }) %>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Balance</td>
                            <% bankData.forEach(bank => { %>
                                <td><%= (bank.balance / 10000000).toFixed(2) %></td>
                            <% }) %>
                        </tr>
                    </tbody>
                </table>
                <div class="grand-total">
                    Total : <%= (totalBankBalance / 10000000).toFixed(2) %>
                </div>
            </section>

            <!-- Collection vs Expenses Section -->
            <section class="report-section">
                <div class="section-title">
                    COLLECTION / EXPENSES
                    <span>(Rs. in Lakhs)</span>
                </div>
                <div class="split-section">
                    <div class="split-col">
                        <div class="split-header">COLLECTION</div>
                        <div class="data-row" style="margin-bottom: 2rem;">
                            <span class="label">Collection Date :</span>
                            <span class="value">
                                <% if (collectionInfo) { %>
                                    <%= collectionInfo.fromDate %> – <%= collectionInfo.toDate %>
                                <% } else { %>
                                    -
                                <% } %>
                            </span>
                        </div>
                        
                        <div class="data-row">
                            <span class="label">Collection</span>
                            <span class="value"><%= collectionInfo ? (collectionInfo.grossCollection / 100000).toFixed(2) : '0.00' %></span>
                        </div>
                        <div class="data-row">
                            <span class="label">Less Batta 11%</span>
                            <span class="value"><%= collectionInfo ? (collectionInfo.batta / 100000).toFixed(2) : '0.00' %></span>
                        </div>
                        <div class="data-row">
                            <span class="label">Less POS</span>
                            <span class="value"><%= collectionInfo ? (collectionInfo.posCharges / 100000).toFixed(2) : '0.00' %></span>
                        </div>
                        
                        <div class="data-row highlight">
                            <span class="label">Net Collection</span>
                            <span class="value"><%= collectionInfo ? (collectionInfo.netCollection / 100000).toFixed(2) : '0.00' %></span>
                        </div>
                    </div>
                    
                    <div class="split-col">
                        <div class="split-header">EXPENSES</div>
                        <div class="data-row">
                            <span class="label">NET</span>
                            <span class="value"><%= collectionInfo ? (collectionInfo.netCollection / 100000).toFixed(2) : '0.00' %></span>
                        </div>
                        <div class="data-row">
                            <span class="label">Oil Exp</span>
                            <span class="value"><%= (expenseInfo.oilExp / 100000).toFixed(2) %></span>
                        </div>
                        <div class="data-row">
                            <span class="label">Other Exp</span>
                            <span class="value"><%= (expenseInfo.otherExp / 100000).toFixed(2) %></span>
                        </div>
                        
                        <div class="data-row highlight">
                            <span class="label">Total Exp</span>
                            <span class="value"><%= (expenseInfo.totalExp / 100000).toFixed(2) %></span>
                        </div>
                        
                        <div class="data-row balance-row">
                            <span class="label">Balance</span>
                            <span class="value"><%= (expenseInfo.balance / 100000).toFixed(2) %></span>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Payments Detail Section -->
            <section class="report-section">
                <div class="section-title">
                    PAYMENTS
                    <span>(Rs. in Lakhs)</span>
                </div>
                <div class="split-section">
                    <div class="split-col">
                        <div class="split-header">OTHER PAYMENTS</div>
                        <table class="horizontal-table" style="box-shadow: none; border: none; margin-bottom: 0;">
                            <tbody>
                                <% if (otherPaymentsList.length > 0) { %>
                                    <% otherPaymentsList.forEach(item => { %>
                                        <tr>
                                            <td style="text-align: left; background: none; border-left: none; width: auto;"><%= item.subCategory %></td>
                                            <td style="text-align: right; border-right: none;"><%= (item.amount / 100000).toFixed(2) %></td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="2" style="text-align: center; color: #64748b; font-style: italic; border: none;">No Other Payments</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                        <% if (otherPaymentsList.length > 0) { %>
                        <div class="grand-total" style="font-size: 1rem; border-top: 1px solid #e2e8f0; padding-top: 0.5rem;">
                            Total : <%= (expenseInfo.otherExp / 100000).toFixed(2) %>
                        </div>
                        <% } %>
                    </div>
                    
                    <div class="split-col">
                        <div class="split-header">HSD PAYMENTS</div>
                        <table class="horizontal-table" style="box-shadow: none; border: none; margin-bottom: 0;">
                            <tbody>
                                <% hsdPaymentsList.forEach(item => { %>
                                    <tr>
                                        <td style="text-align: left; background: none; border-left: none; width: auto;"><%= item.name %></td>
                                        <td style="text-align: right; border-right: none;"><%= (item.amount / 100000).toFixed(2) %></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                        <div class="grand-total" style="font-size: 1rem; border-top: 1px solid #e2e8f0; padding-top: 0.5rem;">
                            Total : <%= (hsdTotal / 100000).toFixed(2) %>
                        </div>
                    </div>
                </div>
            </section>
            <!-- HSD Outstanding Section -->
            <section class="report-section">
                <div class="section-title">
                    HSD OUTSTANDING
                </div>
                <% if (hsdOutstanding && hsdOutstanding.length > 0) { %>
                <table class="horizontal-table" style="text-align: right;">
                    <thead>
                        <tr>
                            <th style="text-align: center; width: 60px;">S.No</th>
                            <th style="text-align: center; width: 120px;">Date</th>
                            <th style="text-align: right;">IOC</th>
                            <th style="text-align: right;">BPC</th>
                            <th style="text-align: right;">HPC</th>
                            <th style="text-align: right;">Retail / Confed</th>
                            <th style="text-align: right;">Ramnad</th>
                            <th style="text-align: right;">CNG</th>
                            <th style="text-align: right;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% 
                           let grandTotalIOC = 0;
                           let grandTotalBPC = 0;
                           let grandTotalHPC = 0;
                           let grandTotalRetail = 0;
                           let grandTotalRamnad = 0;
                           let grandTotalCNG = 0;
                           let grandTotalAll = 0;
                        %>
                        <% hsdOutstanding.forEach((r, index) => { 
                            grandTotalIOC += (Number(r.IOC) || 0);
                            grandTotalBPC += (Number(r.BPC) || 0);
                            grandTotalHPC += (Number(r.HPC) || 0);
                            grandTotalRetail += (Number(r['Retail / Confed']) || 0);
                            grandTotalRamnad += (Number(r.Ramnad) || 0);
                            grandTotalCNG += (Number(r.CNG) || 0);
                            grandTotalAll += (Number(r.total) || 0);
                        %>
                            <tr>
                                <td style="text-align: center; background: none; font-weight: 400;"><%= index + 1 %></td>
                                <td style="text-align: center; background: none; font-weight: 400;"><%= r.date %></td>
                                <td><%= ((Number(r.IOC) || 0) / 100000).toFixed(2) %></td>
                                <td><%= ((Number(r.BPC) || 0) / 100000).toFixed(2) %></td>
                                <td><%= ((Number(r.HPC) || 0) / 100000).toFixed(2) %></td>
                                <td><%= ((Number(r['Retail / Confed']) || 0) / 100000).toFixed(2) %></td>
                                <td><%= ((Number(r.Ramnad) || 0) / 100000).toFixed(2) %></td>
                                <td><%= ((Number(r.CNG) || 0) / 100000).toFixed(2) %></td>
                                <td style="font-weight: 800;"><%= ((Number(r.total) || 0) / 100000).toFixed(2) %></td>
                            </tr>
                        <% }) %>
                    </tbody>
                    <tfoot style="background: #f8fafc; font-weight: 800; border-top: 2px solid #1a3c5e;">
                        <tr>
                            <td colspan="2" style="text-align: right;">TOTAL</td>
                            <td><%= (grandTotalIOC / 100000).toFixed(2) %></td>
                            <td><%= (grandTotalBPC / 100000).toFixed(2) %></td>
                            <td><%= (grandTotalHPC / 100000).toFixed(2) %></td>
                            <td><%= (grandTotalRetail / 100000).toFixed(2) %></td>
                            <td><%= (grandTotalRamnad / 100000).toFixed(2) %></td>
                            <td><%= (grandTotalCNG / 100000).toFixed(2) %></td>
                            <td style="color: #1a3c5e;"><%= (grandTotalAll / 100000).toFixed(2) %></td>
                        </tr>
                    </tfoot>
                </table>
                <% } else { %>
                <div style="text-align: center; padding: 2rem; background: white; border: 1px solid #e2e8f0; border-radius: 8px; color: #64748b; font-style: italic;">
                    No HSD Outstanding Data
                </div>
                <% } %>
            </section>
        </main>
    </div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Planning - TNSTC Finance Planner</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header"><h2>TNSTC Finance</h2></div>
        <ul class="sidebar-menu">
            <li><a href="/">Dashboard</a></li>
            <li><a href="/bank-balances">Bank Balances</a></li>
            <li><a href="/daily-collections">Daily Collections</a></li>
            <li><a href="/payment-planning" class="active">Payment Planning</a></li>
            <li><a href="/hsd-management">HSD Management</a></li>
            <li><a href="/financial-report">Financial Report</a></li>
            <li><a href="#">Financial Reports</a></li>
        </ul>
    </nav>
    <div class="main-content">
        <header>
            <h1>Payment Planning</h1>
            <p class="date-range">Capture Planned Payments</p>
        </header>
        <main class="container">
            <div class="fund-summary-banner">
                <div class="summary-item">
                    <span class="label">Available Fund</span>
                    <span class="value" id="availableFund">₹<%= availableFund.toLocaleString('en-IN', { minimumFractionDigits: 2 }) %></span>
                </div>
                <div class="summary-item">
                    <span class="label">Total Planned Amount</span>
                    <span class="value highlight-planned" id="totalPlanned">₹0.00</span>
                </div>
                <div class="summary-item">
                    <span class="label">Remaining Balance</span>
                    <span class="value" id="remainingBalance">₹<%= availableFund.toLocaleString('en-IN', { minimumFractionDigits: 2 }) %></span>
                </div>
            </div>

            <section class="planning-section">
                <div class="section-header">
                    <h2>Planned Payment Entry</h2>
                    <div class="controls">
                        <label>Position Date:</label>
                        <input type="date" id="posDate" value="<%= positionDate %>" onchange="window.location.href='/payment-planning?positionDate='+this.value">
                    </div>
                </div>

                <form id="planningForm" class="planning-form">
                    <input type="hidden" name="positionDate" value="<%= positionDate %>">
                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label>Bank Account *</label>
                        <select name="bankId" id="bankSelect" required style="width: 100%; padding: 0.8rem; border-radius: 6px;" onchange="window.location.href='/payment-planning?positionDate=' + document.getElementById('posDate').value + '&bankId=' + this.value">
                            <% banks.forEach(bank => { %>
                                <option value="<%= bank.id %>" <%= bankId === bank.id ? 'selected' : '' %>><%= bank.bankName %> - <%= bank.accountNumber %></option>
                            <% }) %>
                        </select>
                    </div>

                    <div class="category-grid">
                        <!-- Category blocks will be here -->
                        <div class="category-block" data-category="Oil Companies">
                            <div class="category-header">
                                <h3>1. Oil Companies</h3>
                                <span class="category-total" id="total-Oil-Companies">₹0.00</span>
                            </div>
                            <div class="sub-category"><span>IOC</span><input type="number" data-cat="Oil Companies" data-sub="IOC" step="0.01" min="0"></div>
                            <div class="sub-category"><span>BPC</span><input type="number" data-cat="Oil Companies" data-sub="BPC" step="0.01" min="0"></div>
                            <div class="sub-category"><span>HPC</span><input type="number" data-cat="Oil Companies" data-sub="HPC" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Retail / Confed</span><input type="number" data-cat="Oil Companies" data-sub="Retail / Confed" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Ramnad</span><input type="number" data-cat="Oil Companies" data-sub="Ramnad" step="0.01" min="0"></div>
                            <div class="sub-category"><span>CNG</span><input type="number" data-cat="Oil Companies" data-sub="CNG" step="0.01" min="0"></div>
                        </div>

                        <div class="category-block" data-category="Region Fund">
                            <div class="category-header">
                                <h3>2. Region Fund</h3>
                                <span class="category-total" id="total-Region-Fund">₹0.00</span>
                            </div>
                            <div class="sub-category"><span>MV Tax</span><input type="number" data-cat="Region Fund" data-sub="MV Tax" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Canteen</span><input type="number" data-cat="Region Fund" data-sub="Canteen" step="0.01" min="0"></div>
                            <div class="sub-category"><span>EB</span><input type="number" data-cat="Region Fund" data-sub="EB" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Sweeper / Labour / RC & RT</span><input type="number" data-cat="Region Fund" data-sub="Sweeper / Labour / RC & RT" step="0.01" min="0"></div>
                            <div class="sub-category"><span>IT</span><input type="number" data-cat="Region Fund" data-sub="IT" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Texco</span><input type="number" data-cat="Region Fund" data-sub="Texco" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Telephone</span><input type="number" data-cat="Region Fund" data-sub="Telephone" step="0.01" min="0"></div>
                        </div>

                        <div class="category-block" data-category="Employee Related Payment 1 (Own Fund)">
                            <div class="category-header">
                                <h3>3. Employee Related Payment 1 (Own Fund)</h3>
                                <span class="category-total" id="total-Employee-Related-Payment-1--Own-Fund-">₹0.00</span>
                            </div>
                            <div class="sub-category"><span>Officer TA-Bill</span><input type="number" data-cat="Employee Related Payment 1 (Own Fund)" data-sub="Officer TA-Bill" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Act Apprentice Salary</span><input type="number" data-cat="Employee Related Payment 1 (Own Fund)" data-sub="Act Apprentice Salary" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Incentive / TA-Bill</span><input type="number" data-cat="Employee Related Payment 1 (Own Fund)" data-sub="Incentive / TA-Bill" step="0.01" min="0"></div>
                            <div class="sub-category"><span>RBS</span><input type="number" data-cat="Employee Related Payment 1 (Own Fund)" data-sub="RBS" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Union / Court Recovery</span><input type="number" data-cat="Employee Related Payment 1 (Own Fund)" data-sub="Union / Court Recovery" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Marriage Advance</span><input type="number" data-cat="Employee Related Payment 1 (Own Fund)" data-sub="Marriage Advance" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Interest (EL, PF, CPS, Gratuity)</span><input type="number" data-cat="Employee Related Payment 1 (Own Fund)" data-sub="Interest (EL, PF, CPS, Gratuity)" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Advance (PF, CPS)</span><input type="number" data-cat="Employee Related Payment 1 (Own Fund)" data-sub="Advance (PF, CPS)" step="0.01" min="0"></div>
                        </div>

                        <div class="category-block" data-category="Employee Related Payment 2 (TDFC / Govt Fund)">
                            <div class="category-header">
                                <h3>4. Employee Related Payment 2 (TDFC / Govt Fund)</h3>
                                <span class="category-total" id="total-Employee-Related-Payment-2--TDFC---Govt-Fund-">₹0.00</span>
                            </div>
                            <div class="sub-category"><span>Salary</span><input type="number" data-cat="Employee Related Payment 2 (TDFC / Govt Fund)" data-sub="Salary" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Bonus</span><input type="number" data-cat="Employee Related Payment 2 (TDFC / Govt Fund)" data-sub="Bonus" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Festival Advance</span><input type="number" data-cat="Employee Related Payment 2 (TDFC / Govt Fund)" data-sub="Festival Advance" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Performance Incentive</span><input type="number" data-cat="Employee Related Payment 2 (TDFC / Govt Fund)" data-sub="Performance Incentive" step="0.01" min="0"></div>
                            <div class="sub-category"><span>EL</span><input type="number" data-cat="Employee Related Payment 2 (TDFC / Govt Fund)" data-sub="EL" step="0.01" min="0"></div>
                            <div class="sub-category"><span>PF</span><input type="number" data-cat="Employee Related Payment 2 (TDFC / Govt Fund)" data-sub="PF" step="0.01" min="0"></div>
                            <div class="sub-category"><span>CPS</span><input type="number" data-cat="Employee Related Payment 2 (TDFC / Govt Fund)" data-sub="CPS" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Gratuity</span><input type="number" data-cat="Employee Related Payment 2 (TDFC / Govt Fund)" data-sub="Gratuity" step="0.01" min="0"></div>
                        </div>

                        <div class="category-block" data-category="Other Payment">
                            <div class="category-header">
                                <h3>5. Other Payment</h3>
                                <span class="category-total" id="total-Other-Payment">₹0.00</span>
                            </div>
                            <div class="sub-category"><span>TDFC Interest / Repayment</span><input type="number" data-cat="Other Payment" data-sub="TDFC Interest / Repayment" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Material</span><input type="number" data-cat="Other Payment" data-sub="Material" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Cess / Toll</span><input type="number" data-cat="Other Payment" data-sub="Cess / Toll" step="0.01" min="0"></div>
                            <div class="sub-category"><span>MCOP</span><input type="number" data-cat="Other Payment" data-sub="MCOP" step="0.01" min="0"></div>
                            <div class="sub-category"><span>Bank Clearance</span><input type="number" data-cat="Other Payment" data-sub="Bank Clearance" step="0.01" min="0"></div>
                        </div>
                    </div>

                    <div class="form-actions" style="margin-top: 2rem;">
                        <button type="submit" class="btn-primary">Save Planned Payments</button>
                    </div>
                </form>

                <div class="summary-section" style="margin-top: 3rem;">
                    <h3>Planned Payments Summary</h3>
                    <table class="master-table">
                        <thead>
                            <tr><th>Category</th><th>Sub Category</th><th>Amount (₹)</th></tr>
                        </thead>
                        <tbody>
                            <% entries.forEach(e => { %>
                                <tr><td><%= e.category %></td><td><%= e.subCategory %></td><td>₹<%= e.amount.toLocaleString('en-IN', { minimumFractionDigits: 2 }) %></td></tr>
                            <% }) %>
                        </tbody>
                        <tfoot>
                            <tr style="font-weight: bold; background: #f9f9f9;">
                                <td colspan="2" style="text-align: right;">Grand Total:</td>
                                <td id="summaryGrandTotal">₹<%= entries.reduce((sum, e) => sum + e.amount, 0).toLocaleString('en-IN', { minimumFractionDigits: 2 }) %></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <style>
        .fund-summary-banner {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
            background: #1a3c5e;
            padding: 1.5rem;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            text-align: center;
        }
        .summary-item .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            font-weight: 600;
        }
        .summary-item .value {
            font-size: 1.5rem;
            font-weight: 800;
        }
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #1a3c5e;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .category-header h3 {
            font-size: 0.9rem;
            margin: 0;
            color: #1a3c5e;
            border-bottom: none;
            padding-bottom: 0;
        }
        .category-total {
            font-size: 0.9rem;
            font-weight: 700;
            color: #1a3c5e;
        }
        .highlight-planned { color: #f39c12; }
        .negative-balance { color: #ff6b6b !important; }

        .planning-section { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .category-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .category-block { border: 1px solid #eee; padding: 1rem; border-radius: 8px; background: #fcfcfc; }
        .category-block h3 { font-size: 0.9rem; margin-top: 0; color: #1a3c5e; border-bottom: 2px solid #1a3c5e; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .sub-category { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; gap: 0.5rem; }
        .sub-category span { font-size: 0.8rem; font-weight: 500; color: #555; }
        .sub-category input { width: 100px; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; }
        .btn-primary { background: #1a3c5e; color: white; border: none; padding: 0.8rem 2rem; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .master-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .master-table th, .master-table td { text-align: left; padding: 0.8rem; border-bottom: 1px solid #eee; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    </style>

    <script>
        // Fund calculation logic
        const rawAvailableFund = <%= availableFund %>;
        
        function updateFundSummary() {
            let totalPlanned = 0;
            const categoryTotals = {};

            document.querySelectorAll('input[data-sub]').forEach(input => {
                const val = parseFloat(input.value) || 0;
                totalPlanned += val;
                
                const cat = input.dataset.cat;
                categoryTotals[cat] = (categoryTotals[cat] || 0) + val;
            });

            // Update category running totals
            Object.keys(categoryTotals).forEach(cat => {
                // Remove all special characters to create a safe ID
                const safeId = 'total-' + cat.replace(/[^a-zA-Z0-9]/g, '-');
                const el = document.getElementById(safeId);
                if (el) {
                    el.innerText = '₹' + categoryTotals[cat].toLocaleString('en-IN', { minimumFractionDigits: 2 });
                }
            });

            const remaining = rawAvailableFund - totalPlanned;
            
            document.getElementById('totalPlanned').innerText = '₹' + totalPlanned.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            const remainingEl = document.getElementById('remainingBalance');
            remainingEl.innerText = '₹' + remaining.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            
            if (remaining < 0) {
                remainingEl.classList.add('negative-balance');
            } else {
                remainingEl.classList.remove('negative-balance');
            }

            // Update Summary Table Grand Total
            const summaryGrandTotalEl = document.getElementById('summaryGrandTotal');
            if (summaryGrandTotalEl) {
                summaryGrandTotalEl.innerText = '₹' + totalPlanned.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            }
        }

        // Add event listeners to all inputs
        document.querySelectorAll('input[data-sub]').forEach(input => {
            input.addEventListener('input', updateFundSummary);
        });

        // Load existing data into inputs
        const currentEntries = <%- JSON.stringify(entries) %>;
        currentEntries.forEach(e => {
            const input = document.querySelector(`input[data-sub="${e.subCategory}"]`);
            if (input) input.value = e.amount;
        });
        
        // Initial summary update
        updateFundSummary();

        document.getElementById('planningForm').onsubmit = async (e) => {
            e.preventDefault();
            const posDate = document.getElementById('posDate').value;
            const bankId = e.target.bankId.value;
            const payments = [];
            
            document.querySelectorAll('input[data-sub]').forEach(input => {
                const amount = parseFloat(input.value) || 0;
                if (amount > 0) {
                    payments.push({
                        category: input.dataset.cat,
                        subCategory: input.dataset.sub,
                        amount: amount
                    });
                }
            });

            if (payments.length === 0) {
                alert('Please enter at least one payment amount');
                return;
            }

            // Hard Validation: Total Planned Amount > Available Fund
            let totalPlanned = 0;
            payments.forEach(p => totalPlanned += p.amount);
            
            if (totalPlanned > rawAvailableFund) {
                alert('Planned amount exceeds available net collection.');
                return;
            }

            try {
                const res = await fetch('/payment-planning/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ positionDate: posDate, bankId, payments })
                });
                if (res.ok) {
                    alert('Planned payments saved successfully');
                    window.location.reload();
                }
            } catch (err) { alert('Save failed'); }
        };
    </script>
</body>
</html>
